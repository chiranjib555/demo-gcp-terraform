name: Qodo PR review (toggleable)

on:
  pull_request: 
    types: [opened, reopened, synchronize, ready_for_review]
  issue_comment: 
    types: [created]  # keep manual /review available even if auto is OFF
  workflow_dispatch:  # Manual trigger from Actions UI
    inputs:
      pr_number:
        description: 'PR number or URL to review'
        required: true
        type: string
      mode:
        description: 'Review mode'
        required: false
        type: choice
        default: 'review'
        options:
          - review
          - improve
          - describe
          - summarize

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: read

env:
  # Global toggle: set this in repo variables (Settings → Actions → Variables)
  QODO_ENABLED: ${{ vars.QODO_ENABLED || 'false' }}

jobs:
  qodo:
    # Run conditions:
    # 1. Auto: PR events when QODO_ENABLED == true
    # 2. Manual: Issue comments with /review, /improve, etc.
    # 3. Manual UI: workflow_dispatch (always runs)
    if: >
      (github.event_name == 'pull_request' && env.QODO_ENABLED == 'true') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/')) ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    steps:
      - name: Validate trigger
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "QODO_ENABLED: ${{ env.QODO_ENABLED }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - PR: ${{ github.event.inputs.pr_number }}, Mode: ${{ github.event.inputs.mode }}"
          fi
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run Qodo PR-Agent (Auto or Comment trigger)
        if: github.event_name != 'workflow_dispatch'
        uses: qodo-ai/pr-agent@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # OPENAI_KEY: ${{ secrets.OPENAI_KEY }}  # if you BYO model key
        with:
          trigger_on_pull_request: true
          trigger_on_comment: true
          trigger_comment_command: "/review"
          verbosity_level: medium
          approve_pr_on_self_review: true
      
      - name: Extract PR number from URL or use direct number
        if: github.event_name == 'workflow_dispatch'
        id: extract_pr
        run: |
          INPUT="${{ github.event.inputs.pr_number }}"
          if [[ "$INPUT" =~ /pull/([0-9]+) ]]; then
            PR_NUM="${BASH_REMATCH[1]}"
          else
            PR_NUM="$INPUT"
          fi
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "Processing PR #$PR_NUM"
      
      - name: Run Qodo PR-Agent (Manual UI trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: qodo-ai/pr-agent@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # OPENAI_KEY: ${{ secrets.OPENAI_KEY }}  # if you BYO model key
        with:
          pr_number: ${{ steps.extract_pr.outputs.pr_number }}
          command: "/${{ github.event.inputs.mode || 'review' }}"
          verbosity_level: medium
